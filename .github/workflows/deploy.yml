#!/usr/bin/env bash
set -euo pipefail

OUT_DIR="$1"
mkdir -p "$OUT_DIR"

INDEX="$OUT_DIR/index.yml"

# ---- FIX ----
# Prevent *.zip from expanding to literal when empty
shopt -s nullglob
# ----------------------

# Start fresh
: > "$INDEX"

# Collect zip files
zips=( *.zip )

# If no zip files, exit cleanly (do NOT write placeholder)
if [ ${#zips[@]} -eq 0 ]; then
  exit 0
fi

for zip in "${zips[@]}"; do
  id="${zip%.zip}"
  sha="$(sha256sum "$zip" | awk '{print $1}')"

  cat >> "$INDEX" <<EOF
- id: $id
  name: $id
  version: $(git rev-parse --short HEAD)
  date: $(date '+%Y-%m-%d %H:%M:%S')
  path: $zip
  sha256: $sha

EOF
done
